# Docs Search Regression Harness

This suite benchmarks the Mímir documentation search pipeline against a pinned snapshot of
Spacewalker docs. It runs end-to-end relevance, snippet quality, latency, cost, and chat
continuity checks so we can compare embedding configs and catch regressions.

## Layout

- `fixtures/` – pinned documentation snapshot tarball + metadata (generated by
  `scripts/search_snapshot.py`).
- `configs/` – vector search + pipeline configs consumed via `--embedding-config`.
- `data/` – ground-truth query suites (`queries.jsonl`) and multi-turn chat flows
  (`conversations.jsonl`).
- `baseline/` – stored metric baselines used for regression gating.
- `results/` – JSON/markdown summaries emitted by the test run (ignored by git).

## Local Usage

```bash
# Ensure the docs snapshot exists (first run generates it from current docs/)
python scripts/search_snapshot.py --update

# Install harness dependencies (optionally via separate virtualenv)
pip install -r tests/search/requirements.txt

# Run relevance + latency checks
env PYTHONPATH=. pytest tests/search -m regression \
  --embedding-config tests/search/configs/default_minilm.yaml

# Run conversational flows (uses stubbed LLM responses for determinism)
pytest tests/search -m chat \
  --embedding-config tests/search/configs/default_minilm.yaml
```

The pytest option `--embedding-config` selects a YAML config that enables vector search,
FAISS, and LLM pipeline settings. Add additional configs under `tests/search/configs/` to
benchmark alternative models or parameters.

## Refreshing the Snapshot

Running `python scripts/search_snapshot.py --update` will:

1. Capture the current `docs/` directory into `fixtures/docs_main_<date>.tar.gz`.
2. Write `snapshot_meta.json` with the source commit SHA, doc count, and file hashes.
3. Purge any previous extracted snapshot under `.cache/mimir/docs_snapshot/` so the next
   pytest run rebuilds the index.

Regenerate the query / conversation datasets when new high-value docs land. The helper
`scripts/validate_search_datasets.py` verifies every referenced path exists in the
snapshot.

## Outputs & Reporting

Test runs emit JSON summaries in `tests/search/results/`. Use
`scripts/render_search_report.py` to turn the summaries into a PR-friendly markdown table
and compare against the stored baseline.

## Determinism Notes

- Vector search uses `sentence-transformers/all-MiniLM-L6-v2`; download happens once and is
  cached under `.cache/mimir/models/`.
- LLM interactions are stubbed to avoid real API calls in CI. Cost metrics rely on
  `TelemetryManager` instrumentation but may be zeroed when the stub is active.
- The docs snapshot keeps the corpus stable so metric changes reflect logic or config
  changes, not drifting documentation.
